---
layout: post
title: Getting a Proper MVC Date-picker using jQuery UI
date: 2011-09-03
---
<p>There are plenty of tutorials out there on how to get date-pickers to work in MVC, but most of them that I have seen fall short for some reason or another.&#160; Here are my requirements for a “proper” date-picker in MVC:</p>  <ol>   <li>It must be automatic, when using the <font face="Courier New">EditorFor</font> family of methods. </li>    <li>It must degrade gracefully. That is, it should fall back to a regular text box for users without JavaScript. </li>    <li>It must <em>always</em> work for any complex model. </li>    <li>It must round-trip the data entered, even if the data is an invalid date. </li>    <li>It must be self-contained.&#160; That is, it should not require a script at the top of the page to work. </li> </ol>  <p>Some demos fail to work for complex models, and most require a surrogate script at the top of the page.&#160; We’ll see how to avoid those problems in the coming sections.&#160; I will be assuming that your project already has jQuery and jQuery UI.</p>  <h2>Automatic Editor</h2>  <p>The ability for MVC to automatically pick an editor based on the data-type has been covered at length before, just <a  href="http://otac0n.com/blog/ct.ashx?id=65c5527e-f2aa-4f23-ae12-eadb0d067e88&amp;url=http%3a%2f%2fwww.google.com%2fsearch%3fq%3dEditorTemplates">search Google for “EditorTemplates”</a> if you are looking for examples.</p>  <p>Quickly, then, here is how to add an automatic template for any type:</p>  <ol>   <li>Navigate to the ~/Views/Shared folder of your web project. </li>    <li>Create a folder named “EditorTemplates”, if it does not already exist. </li>    <li>Inside of this folder, create a partial view with the name of your type. (DateTime, in our case). </li> </ol>  <p>We will also choose to have a strongly-typed view, using DateTime? as our type.&#160; This will allow it to work for both nullable and non-nullable dates</p>  <p>Here is how the folder structure should be laid out:</p>  <p><img title="Date Picker - 1 - Layout" alt="Date Picker - 1 - Layout" src="/images/posts/Date%20Picker%20-%201%20-%20Layout.png" width="193" height="244" /></a></p>  <p>Now, MVC will automatically select our editor whenever it has a <font face="Courier New">DateTime</font> or a <font face="Courier New">Nullable&lt;DateTime&gt;</font> to render.</p>  <h2>Round-trippin’ With My Two Favorite Allies</h2>  <p>We need to use a regular HTML text box for our date picker for two reasons:</p>  <ol>   <li>It will allow for date-input, even if the user has disabled JavaScript. </li>    <li>MVC will automatically round-trip the data and perform model binding, if it is rendered in a certain way. </li> </ol>  <p>We chose to use a <font face="Courier New">dynamic</font> partial view, so that we could round-trip textual data, above, so the simplest way to get the editor working is this, placed in the DateTime.cshtml file:</p>  <pre class="code"><span style="background: yellow">@model </span><span style="color: #2b91af">DateTime</span>?
<span style="background: yellow">@</span>Html.TextBox(<span style="color: #a31515">&quot;&quot;</span>, Model)</pre>

<p>Interestingly, we are passing an empty string in for the “name” parameter for the text box.&#160; This is the <em>secret sauce</em> for getting MVC to render the proper name to support complex models and for it to automatically round-trip the model for.&#160; Second, we are simply passing the model as the value of the text box.&#160; MVC will take this and call <font face="Courier New">ToString()</font> on the value, which will give us the default formatting for dates.</p>

<p>We may, however, want dates to be shown without their time component. To do that, we need to override the default formatting to our liking:</p>

<pre class="code"><span style="background: yellow">@model </span><span style="color: #2b91af">DateTime</span>?
<span style="background: yellow">@</span>Html.TextBox(<span style="color: #a31515">&quot;&quot;</span>, Model.HasValue ? Model.Value.ToString(<span style="color: #a31515">&quot;d MMM yyyy&quot;</span>) : <span style="color: #a31515">&quot;&quot;</span>)</pre>

<font face="Verdana">This will not prevent the users’ input from round-tripping, but will instead provide a default formatting for views where there is no posted data to reference, e.g. loading the edit view for the first time.</font>

<h2>Self-contained Script</h2>

<p>Some people prefer to have a single script for wiring-up their date-pickers at the top of the page.&#160; I find this to be less than ideal, because I usually don’t date pickers on a page, so it doesn’t belong in the master layout.&#160; I also don’t want to duplicate the code on every page, because it means that a simple change to the date picker would have to be performed in many places, and it could easily be forgotten on a page, preventing date pickers from working there.</p>

<p>With that in mind, my preference is to have a self-contained script for creating the date-picker immediately following the text box.&#160; The challenge that we face when we want to do this is coming up with a way to refer to the specific text-box in a jQuery selector.&#160; The easiest way, from a jQuery standpoint, would be to use the ID of the text box.</p>

<p>Luckily, MVC allows us access to the field name using the <font face="Courier New">Html.ViewContext.ViewData.TemplateInfo.GetFullHtmlFieldName</font> method.&#160; This is, in fact, the way that MVC assigns the name and ID to the text box.&#160; However, there is no built-in way to turn that name into an ID.&#160; A quick perusal of the MVC source code shows that the ID is a simple text replacement.&#160; We can precisely emulate their text replacement with a regular expression replacement.&#160; Here is the completed control:</p>

<pre class="code"><span style="background: yellow">@model </span><span style="color: #2b91af">DateTime</span>?
<span style="background: yellow">@{
</span>    <span style="color: blue">var </span>name = Html.ViewContext.ViewData.TemplateInfo.GetFullHtmlFieldName(<span style="color: blue">string</span>.Empty);
    <span style="color: blue">var </span>id = System.Text.RegularExpressions.<span style="color: #2b91af">Regex</span>.Replace(name, <span style="color: #a31515">@&quot;[^-\w\d:_]&quot;</span>, <span style="color: #2b91af">HtmlHelper</span>.IdAttributeDotReplacement);
<span style="background: yellow">}
@</span>Html.TextBox(<span style="color: #a31515">&quot;&quot;</span>, Model.HasValue ? Model.Value.ToString(<span style="color: #a31515">&quot;d MMM yyyy&quot;</span>) : <span style="color: #a31515">&quot;&quot;</span>)<span style="color: blue">&lt;</span><span style="color: maroon">script </span><span style="color: red">type</span><span style="color: blue">=&quot;text/javascript&quot;&gt;</span>$(function () { $(&quot;#<span style="background: yellow">@</span>id&quot;).datepicker({ dateFormat: 'd M yy' }); });<span style="color: blue">&lt;/</span><span style="color: maroon">script</span><span style="color: blue">&gt;
</span></pre>

<p>Now, we have a feature-complete, self-contained date picker, that is automatically applied for all DateTime fields!</p>
